@page "/favorites"
<link href="css/catList.css" rel="stylesheet" />

@inject AuthenticationStateProvider AuthStateProvider
@inject IFavoritesClient favoritesClient
@inject ICatClient httpClient
@inject IConfiguration Configuration
@attribute [Authorize]

<h3>Favoris</h3>

@if (!isAuthenticated)
{
    <p>Vous devez être connecté pour voir vos favoris.</p>
}
else if (isAdmin)
{
    <p>Cette page est réservée aux utilisateurs non administrateurs.</p>
}
else if (favoriteCats == null)
{
    <p>Chargement...</p>
}
else if (!favoriteCats.Any())
{
    <p>Vous n'avez aucun chat en favoris pour le moment.</p>
}
else
{
    <div class="cat-cards-container">
        @foreach (var cat in favoriteCats)
        {
            <div class="cat-card">
                <img src="@($"{Configuration["ApiBaseUrl"]}/images/{cat.photos?.FirstOrDefault()?.photoUrl ?? "default.png"}")" alt="@cat.name" />
                <h4>@cat.name</h4>
                <p><strong>Âge :</strong> @cat.age ans</p>
                <p><strong>Sexe :</strong> @cat.sex</p>
                <p>@cat.description</p>
            </div>
        }
    </div>
}

@code {
    private bool isAuthenticated = false;
    private bool isAdmin = false;

    private List<Cat>? favoriteCats;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        isAdmin = user.IsInRole("admin");

        if (isAuthenticated && !isAdmin)
        {
            await LoadFavorites();
        }
    }

    private async Task LoadFavorites()
    {
        var favorites = await favoritesClient.GetMyFavoritesAsync();
        var catIds = favorites.Select(f => f.catId).ToList();
        var allCats = await httpClient.GetCatItemsAsync();

        favoriteCats = allCats.Where(c => catIds.Contains(c.id)).ToList();
    }
}