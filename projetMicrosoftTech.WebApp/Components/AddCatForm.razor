@using projetMicrosoftTech.WebApp.Clients
@using projetMicrosoftTech.Persistence
@inject ICatClient httpClient

<EditForm EditContext="editContext" OnValidSubmit="Submit">
    <div class="mb-3">
        <label for="catName" class="form-label">Nom du chat</label>
        <InputText id="catName" class="form-control" @bind-Value="Model!.name" placeholder="Entrez le nom du chat" />
        <ValidationMessage For="() => Model!.name" />
    </div>

    <div class="mb-3">
        <label for="catAge" class="form-label">Âge</label>
        <InputNumber id="catAge" class="form-control" @bind-Value="Model!.age" />
        <ValidationMessage For="() => Model!.age" />
    </div>

    <div class="mb-3">
        <label for="catSex" class="form-label">Sexe</label>
        <InputSelect id="catSex" class="form-control" @bind-Value="Model!.sex">
            <option value="">Sélectionnez</option>
            <option value="mâle">Mâle</option>
            <option value="femelle">Femelle</option>
        </InputSelect>
        <ValidationMessage For="() => Model!.sex" />
    </div>

    <div class="mb-3">
        <label for="catDescription" class="form-label">Description</label>
        <InputTextArea id="catDescription" class="form-control" @bind-Value="Model!.description" rows="3" />
    </div>

    <div class="mb-3">
        <label for="catPhotos" class="form-label">Photos du chat</label>
        <InputFile id="catPhotos" OnChange="HandleSelectedFiles" multiple />
        @if (selectedFiles.Count > 0)
        {
            <ul>
                @foreach (var file in selectedFiles)
                {
                    <li>@file.Name (@file.Size / 1024) KB</li>
                }
            </ul>
        }
    </div>

    <button type="submit" class="btn btn-primary">Ajouter le chat</button>
</EditForm>

@code {
    private CatFormItem? Model { get; set; }
    private EditContext? editContext;
    private ValidationMessageStore? messageStore;

    private List<IBrowserFile> selectedFiles = new();

    [Parameter]
    public EventCallback OnCatAdded { get; set; }

    protected override void OnInitialized()
    {
        Model ??= new CatFormItem();
        editContext = new EditContext(Model);
        messageStore = new ValidationMessageStore(editContext);
        editContext.OnValidationRequested += HandleValidationRequested;
    }

    private void HandleValidationRequested(object? sender, ValidationRequestedEventArgs args)
    {
        messageStore?.Clear();

        if (string.IsNullOrWhiteSpace(Model!.name))
            messageStore?.Add(() => Model.name, "Le nom du chat est requis.");

        if (Model.age < 0)
            messageStore?.Add(() => Model.age, "L'âge doit être positif.");
    }

    private void HandleSelectedFiles(InputFileChangeEventArgs e)
    {
        selectedFiles.Clear();
        foreach (var file in e.GetMultipleFiles())
        {
            selectedFiles.Add(file);
        }
    }

    private async Task Submit()
    {
        if (Model is not null)
        {
            // Crée le chat
            var newCat = new Cat
            {
                id = 0,
                name = Model.name,
                age = Model.age,
                sex = Model.sex,
                description = Model.description
            };

            // Envoie vers ton API
            var createdCat = await httpClient.CreateCatItemAsync(newCat);

            // Upload des photos
            foreach (var file in selectedFiles)
            {
                using var memoryStream = new MemoryStream();
                using var fileStream = file.OpenReadStream(maxAllowedSize: 5_000_000);
                await fileStream.CopyToAsync(memoryStream);
                var buffer = memoryStream.ToArray();

                await httpClient.UploadCatPhotoAsync(createdCat.id, file.Name, buffer);
            }

            if (OnCatAdded.HasDelegate)
                await OnCatAdded.InvokeAsync();

            Model = new CatFormItem();
            selectedFiles.Clear();
            editContext = new EditContext(Model);
        }
    }

    public class CatFormItem
    {
        public string name { get; set; } = string.Empty;
        public int age { get; set; }
        public string sex { get; set; } = string.Empty;
        public string description { get; set; } = string.Empty;
    }
}